<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <style type="text/css">
        #preview
        {
            border:1px solid #000;
        }
        body,html{width: 100%;height: 100%;}
        #mask{
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, .6);
        }
        #setAvatar{
            width: 400px;
            height: 550px;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-left: -200px;
            margin-top : -275px;
            background: rgb(255, 255, 255);
            z-index: 999;
        }
        .Modal-title{
            margin-top: 40px;
            font-size: 24px;
            font-weight: 500;
            text-align: center;
        }
        #UserAvatarEditor-container{
            width: 256px;
            height: 256px;
            margin: 0 auto 30px;
            cursor: move;
            position: relative;
            overflow: hidden;
        }
        .RangeInput{
            width: 220px;
            height: 12px;
            position: absolute;
            top:70%;
            left: 50%;
            margin-left: -110px;
            vertical-align: middle;
            background: transparent;
            -webkit-appearance: none;
        }
    </style>
</head>
<body>
<form action="#" method="post">
    <!--<div id="preview"></div>-->
    <input type="file" onchange="fileChange(this);" name="up_file" id="avatar"/>
    <input id="submit_upload" type="submit" class="load-btn" value="上传" disabled />
</form>

<script type="text/javascript">
    /*图片预览函数*/
    function preview(file, preMask)
    {
        var prevDiv = document.getElementById('UserAvatarEditor-container');
        if (file.files && file.files[0])
        {
            var reader = new FileReader();

            reader.onload = function(evt){
                var oImg = new Image();
                oImg.src = evt.target.result;
                oImg.style.cssText = "position:absolute;"
                oImg.onload = function(){
                    var flag = oImg.offsetWidth/oImg.offsetHeight;
//                    console.log(flag);
                    var container = preMask.parentNode;
                    var boundary;
                    /*确定图片是横放还是竖放,*/
                    if(flag >1 ){
                        oImg.style.cssText += "height: 160px;top: 50%;margin-top: -80px;left: 48px";
//                        oImg.style.cssText += "left: 50%;margin-left: -"+oImg.offsetWidth/2+"px;"
                        boundary = {left: 190,right: (350 - oImg.offsetWidth),top: 128, bottom: (288 -oImg.offsetHeight)};

                    }else if(flag == 1)
                    {
                        oImg.style.cssText += "height: 160px;top: 50%;margin-top: -80px;left: 50%;margin-left: -80px";

                    }
                    else{
                        oImg.style.cssText += "width: 160px;left: 50%;margin-left: -80px;";
                        oImg.style.cssText += "top: 50%;margin-top: -"+oImg.offsetHeight/2+"px;";
                        boundary = {left: 128,right: (288 - oImg.offsetWidth),top: 156, bottom: (316 -oImg.offsetHeight)};
                    }
                    if(boundary !== undefined)
                    drag(container, oImg, boundary);
                };

//                console.log(oImg.offsetWidth);
//                prevDiv.innerHTML = '<img src="' + evt.target.result + '" style="width:256px"/>';
                prevDiv.appendChild(oImg);
            }
            reader.readAsDataURL(file.files[0]);
        }
        else
        {
//            prevDiv.appendChild(oImg);
          prevDiv.innerHTML = '<div class="img" style="filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale,src=\'' + file.value + '\'"></div>';
        }
    }
    /*文件大小检测*/
    function fileChange(target){
    /*检测上传文件的类型*/
        var btn = document.getElementById('submit_upload');
        var imgName = document.getElementById('avatar').value;
        var ext,idx;

        if (imgName == ''){
            btn.disabled=true;
            alert("请选择需要上传的文件!");
            return;
        } else {
            idx = imgName.lastIndexOf(".");
            if (idx != -1){
                ext = imgName.substr(idx+1).toUpperCase();
                ext = ext.toLowerCase( );
                // alert("ext="+ext);
                if (ext != 'jpg' && ext != 'png' && ext != 'jpeg' && ext != 'gif'){
                    btn.disabled=true;
                    alert("只能上传.jpg  .png  .jpeg  .gif类型的文件!");
                    return;
                }
            } else {
                btn.disabled=true;
                alert("只能上传.jpg  .png  .jpeg  .gif类型的文件!");
                return;
            }
        }

        /*检测上传文件的大小*/
        var isIE = /msie/i.test(navigator.userAgent) && !window.opera;
        var fileSize = 0;
        if (isIE && !target.files){
            var filePath = target.value;
            var fileSystem = new ActiveXObject("Scripting.FileSystemObject");
            var file = fileSystem.GetFile (filePath);
            fileSize = file.Size;
        } else {
            fileSize = target.files[0].size;
        }

        var size = fileSize ;
        if(size>(1024*1024*3)){
            btn.disabled=true;
            alert("文件大小不能超过3M");
        }else{
            /*所有验证都通过了,开始弹层*/
            doMask(target);
            btn.disabled=false;
        }
    }
    function addEvent(ele, event, callback)//监听事件
    {
        if(ele.addEventListener)
        {ele.addEventListener(event,callback,false);
        }else if(el.attachEvent)
        {
            ele.attachEvent('on'+event,callback);
        }
    }
    /*元素拖拽函数*/
    function drag(elem, avatar, boundary)
    {   /*boundary:top, right, bottom, left*/
        elem.onmousedown = function(e){
            e = e || window.event;
            var disX = e.clientX - this.offsetLeft;
            var disY = e.clientY - this.offsetTop;
            document.onmousemove = function(e){
                e = e || window.event;

                avatar.left = e.clientX - disX;
                avatar.top = e.clientY - disY;
                if(avatar.left > boundary.left)
                {
                    avatar.left = boundary.left;
                }else if(avatar.left < boundary.right){
                    avatar.left = boundary.right;
                }
                if(avatar.top > boundary.top)
                {
                    avatar.top = boundary.top;
                }else if(avatar.top < boundary.bottom){
                    avatar.top = boundary.bottom;
                }
                avatar.style.left = avatar.left+"px";
                avatar.style.top = avatar.top + "px";
//                console.log(elem);
                return false;
            };

            elem.onmouseup = function(){
                document.onmousemove = null;//取消事件
            };
        };
    }
    /*图片检测弹层*/
    function doMask(target){
        var mask = document.createElement('div');
        mask.id = "mask";


        /*弹层内容模块*/
        var setAvatar = document.createElement('div');
        setAvatar.id = "setAvatar";
        var h3 = document.createElement('h3');
        h3.className = "Modal-title";
        h3.innerHTML = "编辑头像";

        /*content区*/
        var avatarContainer = document.createElement('div');
        avatarContainer.id = "UserAvatarEditor-container";

        /*关闭小按钮*/
        var closeAll = document.createElement('span');
        closeAll.style.cssText = "width:16px;height:16px;line-height:16px;" +
                ";position:absolute;right:-56px;top:0;padding:14px;background:url(close.png);cursor: pointer ";
        addEvent(closeAll, "click", function(){
            document.body.removeChild(mask);
            document.body.removeChild(setAvatar);
        });

        /*保存按钮*/
        var oInput = document.createElement('input');
        oInput.type = "button";
        oInput.value = "保存";
        oInput.style.cssText = "display: block;width: 220px;background: #0f88eb;border: 1px solid #0f88eb;" +
                "height: 32px;border-radius: 3px;margin: 108px auto;color: white;font-weight: bold";
        addEvent(oInput, "mouseover", function(){
            oInput.style.background = "#0d79d1";
            oInput.style.cursor = "pointer";
        });
        addEvent(oInput, "mouseout", function(){
            oInput.style.background = "#0f88eb";
        });
        /*聚焦框*/
        var preMask = document.createElement("div");
        preMask.style.cssText = "width: 160px;height: 160px;background: transparent;position: absolute;" +
                "left: 0;top: 0;";
        preMask.style.zIndex = 2;
        preMask.style.border = "48px solid rgba(255, 255, 255, .8)";

        /*放大滑块*/
        var slider = document.createElement('input');
        slider.type = "range";
        slider.step = "0.01";
        slider.min = "1";
        slider.max = "2";
        slider.className = "RangeInput";
        slider.value = "1";
        addEvent(slider, "change", function(){
            var oImg = slider.parentNode.childNodes[1].childNodes[1];
            if(oImg.style.width){
                oImg.style.width = slider.value * 160 + "px";

            }else{
                oImg.style.height = slider.value * 160 + "px";
            }
            oImg.style.left = "50%";
            oImg.style.top = "50%";
            oImg.style.marginTop = -oImg.offsetHeight/2 + "px";
            oImg.style.marginLeft = -oImg.offsetWidth/2 + "px";
        });

        /*进行模块的拼接*/
        document.body.appendChild(mask);
        document.body.appendChild(setAvatar);
        avatarContainer.appendChild(preMask);
        setAvatar.appendChild(h3);
        setAvatar.appendChild(avatarContainer);
        setAvatar.appendChild(closeAll);
        setAvatar.appendChild(oInput);
        setAvatar.appendChild(slider);
        preview(target,preMask);
    }
</script>
</body>
</html>